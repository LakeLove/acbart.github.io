

<a href="javascript:void%20function(){var user=ENV.current_user,roles=ENV.current_user_roles,course=ENV.context_asset_string,courseId=course.split("_")[1],base=ENV.DEEP_LINKING_POST_MESSAGE_ORIGIN,linkParser=e=>{let s=/,[\s]*<(.*?)>;[\s]*rel="next"/g.exec(e);return null==s?null:s[1]};function getAll(e,s,t,n,i){var r=[];return e(s,t,function s(a,o,l){r.push(...a);let u=l.getResponseHeader("link"),d=linkParser(u);null!=d?(e(d,t,s),void 0!==i&&i(r)):n(r)})}function prettifyCourse(e){return e.course_code+" - "+e.name}var baseApiUrl=base+"/api/v1/courses/";function loadPreTransferInfo(e,s){$("#wi-report").html("Beginning initial downloads.");let t=[];getAll($.get,baseApiUrl+e+"/assignments",{per_page:100},function(n){getAll($.get,baseApiUrl+s+"/assignments",{per_page:100},function(i){let r=i.reduce((e,s)=>(s.name in e&&(console.error("ISSUE: Duplicate name detected within target course."),t.push("Duplicate assignment name in target course: "+s.name)),e[s.name]=s,e),{}),a={},o=n.filter(e=>e.published).map(e=>{let s=r[e.name];return void 0===s?(t.push(`Assignment from source course not present in target course: <a href='${e.html_url}' target=_blank>${e.name}</a>`),null):s.published?(a[e.id]={source:e,target:s},`<li><a target=_blank href='${e.html_url}'>${e.name}</a></li>`):(t.push(`Published assignment from source course is not published in target course: <a href='${s.html_url}' target=_blank>${s.name}</a>`),null)}).filter(e=>null!==e).join("\n");getAll($.get,baseApiUrl+e+"/users",{"enrollment_type[]":"student",per_page:100},function(n){getAll($.get,baseApiUrl+s+"/users",{"enrollment_type[]":"student",per_page:100},function(i){let r=i.reduce((e,s)=>(e[s.id]=s,e),{}),l=[],u=n.map(e=>{return void 0!==r[e.id]?(l.push(e),`<li>${e.name}</li>`):(t.push(`Student from source course not present in target course: ${e.sortable_name} (Email: ${e.email}, SIS: ${e.sis_user_id})`),null)}).filter(e=>null!==e).join("\n");finishPreTransferReport(e,s,a,o,l,u,t)},function(e){$("#wi-report").html(`Loading target students, downloaded ${e.length} so far, please wait.`)})},function(e){$("#wi-report").html(`Loading source students, downloaded ${e.length} so far, please wait.`)})},function(e){$("#wi-report").html(`Loading target assignments, downloaded ${e.length} so far, please wait.`)})},function(e){$("#wi-report").html(`Loading source assignments, downloaded ${e.length} so far, please wait.`)})}function finishPreTransferReport(e,s,t,n,i,r,a){let o="";a.length>0&&(o="<span>Errors exist:</span>"+a.map(e=>`<li>${e}</li>`).join("\n"));let l=$("<a href='#' class='btn btn-success' role='button'>Begin this transfer?</a>");l.click(function(){beginSubmissionTransfer(e,s,t,i)}),$("#wi-report").html(`<span>Transferable assignments (${Object.keys(t).length}):</span>\n        <ul>${n}</ul>\n        <span>Transferable students (${i.length}):</span>\n        <ul>${r}</ul>\n        ${o}<br>`).append(l)}function beginSubmissionTransfer(e,s,t,n){$("#tr-status").html("Beginning transfer. Make take a while!"),getAll($.get,baseApiUrl+e+"/students/submissions",{"student_ids[]":n.map(e=>e.id),"assignment_ids[]":Object.keys(t),"include[]":["assignment","user"],per_page:100},function(e){$("#tr-status").html(`Uploading target submissions. There are ${e.length} to go.`);let n=0,i=[];e.map(r=>{if("unsubmitted"!==r.workflow_state){let e=transferSubmission(s,t[r.assignment.id].target.id,r);i.push.apply(i,e)}n+=1,$("#tr-status").html(`Uploading target submissions. Started ${n}/${e.length} so far.`)}),Promise.all(i).then(()=>{$("#tr-status").html("Uploaded all target submissions!")}),console.log(e)},function(e){$("#tr-status").html(`Loading source submissions, downloaded ${e.length} so far, please wait. Make take a while!`)})}function transferSubmission(e,s,t){let n=[];t.attachments&&(n=t.attachments.map(e=>e.id));let i=$.post(baseApiUrl+e+"/assignments/"+s+"/submissions",{"submission[submission_type]":t.submission_type,"submission[body]":t.body,"submission[url]":t.url,"submission[user_id]":t.user_id,"submission[submitted_at]":t.submitted_at,"submission[file_ids][]":n},e=>{$("#tr-report").append(`<li>Submitted ${t.assignment.name} for ${t.user.sortable_name}</li>`)});if("graded"===t.workflow_state){return[i,$.ajax({type:"PUT",url:baseApiUrl+e+"/assignments/"+s+"/submissions/"+t.user_id,data:{"submission[posted_grade]":t.grade,"submission[excuse]":t.excused},success:e=>{$("#tr-report").append(`<li>Graded ${t.assignment.name} for ${t.user.sortable_name}</li>`)}})]}return[i]}function makeCourseSelector(e){let s=$('<select id="wi-course-selector" name="wi-course-selector">');s.append("<option></option>");var t=[];return $.each(e,function(e,n){t.includes(n.id)||(s.append($("<option></option>").val(n.id).html(prettifyCourse(n))),t.push(n.id))}),s.change(function(e,t){console.log(e,s.val()),loadPreTransferInfo(s.val(),courseId)}),s}function getCourses(){getAll($.get,base+"/api/v1/courses/",{per_page:100},function(e){loadDialog(e)})}function startDialog(e){$("#dialog").dialog({autoOpen:!1,show:"blind",hide:"explode",width:"80%",height:document.documentElement.clientHeight-100}),$("#dialog").dialog("open"),0==$("#dialog").length&&$(document.body).append('<div title="'+e+'" id="dialog"></div>'),$("#dialog").html("<span>Loading courses, please wait.</span>")}function loadDialog(e){let s=e.filter(e=>e.id==courseId)[0],t=$("<div></div>");t.append("<label for='wi-course-selector'>Transfer submissions from:</label>"),t.append(makeCourseSelector(e)),t.append("<br>"),t.append("<span>To: </span>"),t.append("<span>"+prettifyCourse(s)+"</span>"),t.append($("<div id='wi-report'></div>")),t.append($("<div id='tr-status'></div>")),t.append($("<ol id='tr-report'></ol>")),$("#dialog").html(t)}startDialog("Transfer Submissions"),getCourses();}();">Canvas Transfer Submission Tool</a>
